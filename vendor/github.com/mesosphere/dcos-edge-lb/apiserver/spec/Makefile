UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Linux)
    OS_TYPE = linux
endif
ifeq ($(UNAME_S),Darwin)
    OS_TYPE = darwin
endif
SWAGGER_VERSION ?= 0.11.0
SWAGGER_URL ?= https://github.com/go-swagger/go-swagger/releases/download/$(SWAGGER_VERSION)
SWAGGER_FILE ?= swagger_$(OS_TYPE)_amd64
SWAGGER_BIN ?= $(SWAGGER_URL)/$(SWAGGER_FILE)
SWAGGER = $(CURDIR)/swagger-$(SWAGGER_VERSION)

############## Begin Targets
.PHONY: clean
all: .generated

clean:
	for f in `grep -rl 'generated by the swagger' ../*`; do \
		case $$f in \
			*[.]go) \
				rm $$f \
				;; \
		esac; \
	done
	for f in `grep -rl 'generated by go-swagger' ../*`; do \
		case $$f in \
			*[.]go) \
				rm $$f \
				;; \
		esac; \
	done
	-rm swagger.json
	rm -rf .generated

# Download if not in path
$(SWAGGER):
	curl -LO $(SWAGGER_BIN) \
    || wget $(SWAGGER_BIN) && \
         mv $(SWAGGER_FILE) $(SWAGGER)
	chmod a+x $(SWAGGER)

# Merge old apis with new ones, first arg takes precedence but there should be no conflicts
swagger.json: $(SWAGGER)
	$(SWAGGER) mixin \
		common/swagger.yml \
		v2/swagger.yml \
		v1/swagger.yml \
		> swagger.json

# Docs: https://goswagger.io/generate/server.html
.generated: $(SWAGGER) swagger.json
	cp swagger.json data/swagger.json
	$(SWAGGER) generate server --spec=data/swagger.json --target=../
	$(SWAGGER) generate client --spec=data/swagger.json --target=../
	touch .generated
